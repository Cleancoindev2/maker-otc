#!/usr/bin/env bash
set -ex

test -z $1 && exit 1
if ! [[ $1 =~ ^[0-9]+$ ]]
    then
        exit 1
fi

export SOLC_FLAGS=${SOLC_FLAGS:-"--optimize"}
export ETH_GAS=${ETH_GAS:-"4000000"}
export ETH_FROM=$(seth rpc eth_coinbase)
export NETWORK=$(seth chain)

. ./bin/$NETWORK-dustlimits

test -z $NETWORK && exit 1

dapp build

OTC=$(dapp create MatchingMarket $1)

export SETH_ASYNC=yes

for dustLimit in $dustLimits; do
	token=$(echo $dustLimit | cut -f1 -d-)
	limit=$(echo $dustLimit | cut -f2 -d-)
	seth send $OTC "setMinSell(address, uint)" $token $limit
done

export OTC=$OTC

echo OTC DEPLOYED AT: $OTC
